<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Test IndexedDB Storage - 1000 Records</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      margin-top: 0;
      color: #2f6fe0;
    }
    button {
      background: #2f6fe0;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #2558b0;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .log {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .log-entry {
      padding: 2px 0;
      border-bottom: 1px solid #e9ecef;
    }
    .ui-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }
    .ui-indicator.responsive {
      background: #28a745;
    }
    .ui-indicator.frozen {
      background: #dc3545;
      animation: none;
    }
  </style>
</head>
<body>
  <div class="ui-indicator responsive" id="uiIndicator" title="UI Responsive"></div>
  
  <div class="card">
    <h1>ðŸ§ª Test IndexedDB Storage</h1>
    <p>Test per verificare che 1000 record possono essere inseriti e letti senza bloccare l'interfaccia utente.</p>
  </div>

  <div class="card">
    <h2>Controlli Test</h2>
    <button id="testWrite" onclick="testWrite()">Test Scrittura (1000 record)</button>
    <button id="testRead" onclick="testRead()">Test Lettura</button>
    <button id="testMigration" onclick="testMigration()">Test Migrazione da localStorage</button>
    <button id="clearData" onclick="clearData()">Pulisci Dati</button>
    <button id="clearLog" onclick="clearLog()">Pulisci Log</button>
    
    <div id="status"></div>
    <div id="log" class="log"></div>
  </div>

  <script src="/src/storage/indexeddb.js"></script>
  
  <script>
    let uiCheckInterval;
    let lastUiCheck = Date.now();
    
    // Monitor UI responsiveness
    function monitorUI() {
      const indicator = document.getElementById('uiIndicator');
      uiCheckInterval = setInterval(() => {
        const now = Date.now();
        const elapsed = now - lastUiCheck;
        
        if (elapsed > 150) {
          indicator.className = 'ui-indicator frozen';
          indicator.title = 'UI Frozen - Last update: ' + elapsed + 'ms ago';
        } else {
          indicator.className = 'ui-indicator responsive';
          indicator.title = 'UI Responsive';
        }
        lastUiCheck = now;
      }, 100);
    }
    
    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const timestamp = new Date().toLocaleTimeString('it-IT');
      entry.textContent = `[${timestamp}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }
    
    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.className = 'status ' + type;
      statusEl.textContent = message;
      statusEl.style.display = 'block';
    }
    
    function clearLog() {
      document.getElementById('log').innerHTML = '';
      log('Log pulito');
    }
    
    // Generate test lesson data
    function generateLesson(index) {
      const days = ['LunedÃ¬', 'MartedÃ¬', 'MercoledÃ¬', 'GiovedÃ¬', 'VenerdÃ¬'];
      const subjects = ['Matematica', 'Italiano', 'Inglese', 'Storia', 'Geografia', 'Scienze', 'Arte', 'Musica'];
      const classes = ['1A', '2A', '3A', '1B', '2B', '3B'];
      
      return {
        id: 'lesson-' + index,
        name: subjects[index % subjects.length],
        class: classes[index % classes.length],
        day: index % 5,
        start: String(8 + Math.floor(index % 8)).padStart(2, '0') + ':00',
        duration: 60,
        notes: 'Test lesson #' + index
      };
    }
    
    async function testWrite() {
      const btn = document.getElementById('testWrite');
      btn.disabled = true;
      
      try {
        log('Inizio test scrittura 1000 record...');
        showStatus('Test in corso...', 'info');
        
        const startTime = performance.now();
        const lessons = [];
        
        // Generate 1000 lessons
        for (let i = 0; i < 1000; i++) {
          lessons.push(generateLesson(i));
          
          // Log progress every 100 records
          if ((i + 1) % 100 === 0) {
            log(`Generati ${i + 1}/1000 record...`);
            // Allow UI to update
            await new Promise(resolve => setTimeout(resolve, 0));
          }
        }
        
        log('1000 record generati. Inizio scrittura su IndexedDB...');
        
        const writeStartTime = performance.now();
        await IndexedDBStorage.write({ lessons, settings: {} });
        const writeEndTime = performance.now();
        
        const endTime = performance.now();
        const totalTime = Math.round(endTime - startTime);
        const writeTime = Math.round(writeEndTime - writeStartTime);
        
        log(`âœ“ Scrittura completata in ${writeTime}ms`);
        log(`âœ“ Test completato in ${totalTime}ms (totale)`);
        showStatus(`âœ“ Successo: 1000 record scritti in ${writeTime}ms`, 'success');
        
      } catch (error) {
        log('âœ— Errore durante la scrittura: ' + error.message);
        showStatus('âœ— Errore: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
      }
    }
    
    async function testRead() {
      const btn = document.getElementById('testRead');
      btn.disabled = true;
      
      try {
        log('Inizio test lettura...');
        showStatus('Test in corso...', 'info');
        
        const startTime = performance.now();
        const data = await IndexedDBStorage.read();
        const endTime = performance.now();
        
        const readTime = Math.round(endTime - startTime);
        const recordCount = data.lessons ? data.lessons.length : 0;
        
        log(`âœ“ Lettura completata in ${readTime}ms`);
        log(`âœ“ Record letti: ${recordCount}`);
        showStatus(`âœ“ Successo: ${recordCount} record letti in ${readTime}ms`, 'success');
        
        if (recordCount > 0) {
          log('Primo record: ' + JSON.stringify(data.lessons[0]));
          log('Ultimo record: ' + JSON.stringify(data.lessons[recordCount - 1]));
        }
        
      } catch (error) {
        log('âœ— Errore durante la lettura: ' + error.message);
        showStatus('âœ— Errore: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
      }
    }
    
    async function testMigration() {
      const btn = document.getElementById('testMigration');
      btn.disabled = true;
      
      try {
        log('Inizio test migrazione da localStorage...');
        showStatus('Test in corso...', 'info');
        
        // Create test data in localStorage
        const testData = {
          lessons: [
            { id: 'ls1', name: 'Matematica', class: '3A', day: 0, start: '08:00', duration: 60 },
            { id: 'ls2', name: 'Italiano', class: '3A', day: 1, start: '09:00', duration: 60 }
          ],
          settings: { defaultClass: '3A' }
        };
        
        localStorage.setItem('orariodoc:v1', JSON.stringify(testData));
        log('Dati test inseriti in localStorage');
        
        // Clear IndexedDB migration flag
        const db = await IndexedDBStorage.initDB();
        await new Promise((resolve, reject) => {
          const transaction = db.transaction(['appData'], 'readwrite');
          const store = transaction.objectStore('appData');
          store.delete('migrated_from_localStorage');
          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
        
        log('Flag migrazione resettato');
        
        // Trigger migration by reading
        await IndexedDBStorage.migrateFromLocalStorage();
        log('Migrazione eseguita');
        
        // Verify data
        const data = await IndexedDBStorage.read();
        log('Dati letti dopo migrazione: ' + JSON.stringify(data));
        
        if (data.lessons && data.lessons.length === 2 && data.settings.defaultClass === '3A') {
          log('âœ“ Migrazione verificata con successo');
          showStatus('âœ“ Successo: Dati migrati correttamente da localStorage', 'success');
        } else {
          throw new Error('Dati migrati non corrispondono');
        }
        
      } catch (error) {
        log('âœ— Errore durante il test di migrazione: ' + error.message);
        showStatus('âœ— Errore: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
      }
    }
    
    async function clearData() {
      const btn = document.getElementById('clearData');
      btn.disabled = true;
      
      try {
        log('Pulizia dati...');
        
        // Clear IndexedDB
        const db = await IndexedDBStorage.initDB();
        await new Promise((resolve, reject) => {
          const transaction = db.transaction(['appData'], 'readwrite');
          const store = transaction.objectStore('appData');
          store.clear();
          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        });
        
        // Clear localStorage
        localStorage.removeItem('orariodoc:v1');
        
        log('âœ“ Dati puliti (IndexedDB e localStorage)');
        showStatus('âœ“ Dati puliti', 'success');
        
      } catch (error) {
        log('âœ— Errore durante la pulizia: ' + error.message);
        showStatus('âœ— Errore: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
      }
    }
    
    // Start UI monitoring
    monitorUI();
    log('Test IndexedDB Storage caricato e pronto');
    log('Indicatore UI in alto a destra: verde = UI responsive, rosso = UI bloccata');
  </script>
</body>
</html>
